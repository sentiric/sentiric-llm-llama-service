name: sentiric

networks:
  sentiric-net:
    driver: bridge
    ipam:
      config:
        - subnet: ${NETWORK_SUBNET:-10.88.0.0/16}
          gateway: ${NETWORK_GATEWAY:-10.88.0.1}

volumes:
  
  # =============================================================
  # KATMAN 4: YAPAY ZEKA UZMAN MOTORLARI (AI EXPERT ENGINES)
  # =============================================================

  # [capability-llm]
  llm-llama-models:
  llm-llama-loras: # [YENİ] LoRA adaptörleri için volume
  llm-llama-cache: 


services:
  # =============================================================
  # KATMAN 4: YAPAY ZEKA UZMAN MOTORLARI (AI EXPERT ENGINES)
  # Gerçek AI işini yapan, potansiyel olarak yavaş başlayan servisler.
  # =============================================================

  
  #  [capability-llm]: Büyük Dil Modeli Yetenekleri (LLM Capabilities)
  # --------------------------------------------------    
  llm-llama-service:
    image: ghcr.io/sentiric/sentiric-llm-llama-service:latest-gpu
    env_file: ["${ENV_FILE_PATH}"]
    environment:
      # GPU için varsayılan katman sayısını ezer
      - LLM_LLAMA_SERVICE_GPU_LAYERS=${LLM_LLAMA_SERVICE_GPU_LAYERS:-28}    
    volumes:
      - "${CERTIFICATES_REPO_PATH}:/sentiric-certificates:ro"
      - llm-llama-models:/models
      - llm-llama-loras:/lora_adapters # [YENİ] LoRA dizinini mount et
    ports:
      - "${LLM_LLAMA_SERVICE_HTTP_PORT:-16070}:${LLM_LLAMA_SERVICE_HTTP_PORT:-16070}"
      - "${LLM_LLAMA_SERVICE_GRPC_PORT:-16071}:${LLM_LLAMA_SERVICE_GRPC_PORT:-16071}"
      - "${LLM_LLAMA_SERVICE_METRICS_PORT:-16072}:${LLM_LLAMA_SERVICE_METRICS_PORT:-16072}"
    networks:
      sentiric-net:
        ipv4_address: ${LLM_LLAMA_SERVICE_IPV4_ADDRESS:-10.88.60.7}
    dns:
      - ${DISCOVERY_SERVICE_IPV4_ADDRESS:-10.88.5.1}
      - ${PRIMARY_DNS:-8.8.8.8}
      - ${SECONDARY_DNS:-1.1.1.1}       
    dns_search:
      - ${DISCOVERY_DNS_SEARCH_DOMAIN}
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${LLM_LLAMA_SERVICE_HTTP_PORT}/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60m # Model indirme ve dönüştürme uzun sürebilir
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]